#!/usr/bin/env bash
set -o errexit -o nounset -o pipefail
cd "$(dirname "$0")/.."

RESET="\e[0m"
LRED="\e[91m"
LCYAN="\e[96m"

version=${1-}

if [[ -z $version || $version = '--help' || $version = '-h' ]]; then
    echo "Usage: ${BIN_COMMAND-$0} <version>"
    exit
fi

if [[ -n $(git status --porcelain) ]]; then
    echo -e "${LRED}Error: There are uncommitted local changes${RESET}" >&2
    exit 1
fi

if [[ -n $(cd && git status --porcelain) ]]; then
    echo -e "${LRED}Error: There are uncommitted changes in Dotfiles${RESET}" >&2
    exit 1
fi

echo -e "${LCYAN}Building test version...${RESET}"
bin/build
echo

echo -e "${LCYAN}Testing locally...${RESET}"
bin/test
echo

echo -e "${LCYAN}Building release version...${RESET}"
bin/build "$version"
echo

echo -e "${LCYAN}Tagging in Git (will trigger release via GitHub Actions)...${RESET}"
git tag "v$version"
git push origin HEAD "v$version"
echo

if [[ -d ~/.git && -f ~/.bin/bin ]]; then
    echo -e "${LCYAN}Copying to Dotfiles...${RESET}"
    cp dist/bin ~/.bin/bin
    (
        cd
        git add .bin/bin
        git commit -m "Upgrade to Bin $version"
        git push
    )
    echo
fi

echo -e "${LCYAN}Finished${RESET}"
echo 'Go here to check the release status:'
echo '  https://github.com/bin-cli/bin/actions'
echo
echo 'Then go here to write the changelog and publish the release:'
echo '  https://github.com/bin-cli/bin/releases'
